---
title: ""
subtitle: Oregon DEQ's Water Quality Status and Trends Report for the Oregon Department of Agriculture's Biennial Review of the Agricultural Area Rules and Plans
author: ""
date: ""
output: 
  word_document:
    reference_docx: //deqhq1/WQNPS/Agriculture/Status_and_Trend_Analysis/R_support_files/Report_Template.docx
---



```{r setup, include=FALSE}

library(knitr)
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE, 
                      warning=FALSE, 
                      error = FALSE,
                      cache = FALSE,
                      include = TRUE)
library(RCurl)
library(plyr)
library(sp)
library(wq)
library(chron)
library(reshape)
library(ggplot2)
library(zoo)
library(dplyr)
library(lubridate)
library(base)
library(captioner)

tbls  <- captioner(prefix="**Table")
figs <- captioner(prefix="  \n**Figure")

```


```{r inputs, include=FALSE}

# agwqma, query_dates, and project_dir are different for every Report. Note 'agwqma' must be named exactly 
# how it is named in the agwqma shapefile ('agwqma_shp').
agwqma <- "North Coast"
query_dates <- c("2000-01-01", "2018-03-01")
project_dir <- "//deqhq1/WQNPS/Agriculture/Status_and_Trend_Analysis/North Coast/2018-North-Coast"


word_output <- TRUE

# Everything below here should not change
Rdata_dir <- paste0(project_dir,"/RData")
GIS_dir <- paste0(project_dir,"/GIS")

# Name of output files from main report
# These files should exist already
df_all_clean_file <- paste0(gsub(" ", "_", agwqma), "_df_all_clean_",paste(query_dates, collapse = "."), ".Rdata")
landuse_file <- paste0(gsub(" ", "_", agwqma), "_landuse.Rdata")
stns_file <- paste0(gsub(" ", "_", agwqma), "_stns.Rdata")
status_file <- paste0(gsub(" ", "_", agwqma), "_status.Rdata")
trend_file <- paste0(gsub(" ", "_", agwqma), "_trend.Rdata")
stns_param_summary_file <- paste0(gsub(" ", "_", agwqma), "_station_param_summary.Rdata")

station_summary_map_DO_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_DO.png")
station_summary_map_pH_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_pH.png")
station_summary_map_temp_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_temp.png")
station_summary_map_ecoli_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_ecoli.png")
station_summary_map_entero_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_entero.png")
station_summary_map_tss_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_tss.png")
station_summary_map_tp_file <- paste0(gsub(" ", "_", agwqma), "_station_summary_map_tp.png")


```

```{r load-dataframes, include=FALSE}

load(paste0(Rdata_dir, "/", df_all_clean_file))
load(paste0(Rdata_dir, "/", landuse_file))
load(paste0(Rdata_dir, "/", stns_file))
load(paste0(Rdata_dir, "/", status_file))
load(paste0(Rdata_dir, "/", trend_file))
load(paste0(Rdata_dir, "/", stns_param_summary_file))

Conc_LU <- read.csv("Lookups/Conclusions_LU.csv", na.strings = c("", "NA"))

```

# Executive Summary

## Purpose

This report presents data and analysis that will help DEQ fulfill its roles in the biennial review process described in the Memorandum of Agreement between ODA and DEQ. Water quality status and trends reports are created to inform discussions between DEQ Basin Coordinators and ODA Agriculture Water Quality Specialists prior to the Local Advisory Committee meeting. The discussions between DEQ and ODA prior to the LAC meeting could include: water quality and what's working and not working, source(s) and solutions, data needs and future monitoring to answer these questions. This report presents an analysis of water quality data readily accessible from public databases and available in sufficient quantity to indicate status and trends. Dependent on data availability, DEQ will use the available water quality data to answer the first three questions below. For the fourth bullet, the report is expected to inform DEQ Basin Coordinator analysis, interpretation, and discussion with ODA and the LAC about possible or potential sources:

* What is the status of water quality?
* What is the trend in water quality?
* When applicable, are TMDL load allocations for total phosphorus and total suspended solids being met?
* Can water quality status and trends be attributed to a pollution source or sources?


## Analysis

Analysts retrieved data from DEQ (volunteer monitoring database was not included, however some volunteer data is queried from the Water Quality Portal), EPA and USGS databases. Many organizations provided data that was queried and evaluated for use in this report (see Appendix). The time period for the query was from `r query_dates[1]` to `r query_dates[2]`. Parameters included in the query were temperature, pH, dissolved oxygen, total suspended solids, total phosphorus, and bacteria. Monitoring stations which had at least two years of recent data and/or at least 8 years of data fit the criteria to assess status and trends (see flow chart in full report). 

## Data Sources

The data returned were evaluated for data quality. DEQ data included `r unique(df.all$Status)` data determined following the DEQ's Laboratory Quality Manual. EPA and USGS data were included unless result comments indicated problems with the data. Recent data (after June 2014) from the USGS was marked as provisional data and included in this analysis. Data was evaluated against the applicable Oregon water quality criterion. 

## Land Use

Each monitoring station that fit the criteria to assess water quality status and/or trends was included in the land use analysis. The Stream-Catchment ([StreamCat](https://www.epa.gov/national-aquatic-resource-surveys/streamcat)) developed by EPA was used to summarize the cumulative upstream catchment of each station for primary land use characteristics, based on the National Hydrography Dataset Plus Version 2 geospatial framework.

```{r landuse-exec}

library(knitr)
library(dplyr)
library(plyr)

stn_to_use <-c(unique(stns$Station_ID))

knitr::kable(landuse, digits = 0, padding = 2, caption = tbls(name = "landUse", caption = "Land use and land cover for upstream catchments of stations used in this analysis, stations which fit the decision criteria and have >20% Agriculture and Range coverage are included. Land use and land cover for all stations used in analysis can be found in full report. Source: 2011 NAIP"))

```

## Results Summary

```{r results-summary}

station_summary_tbl <- data.frame(Analyte=c("Ecoli","Enterococcus","Dissolved Oxygen","pH","Temperature","Total Phosphorus","TSS"),
                                  status=c(nrow(unique(status[status$Analyte == "E. Coli", ])),
                                           nrow(unique(status[status$Analyte == "Enterococcus", ])),
                                           nrow(unique(status[status$Analyte == "Dissolved Oxygen", ])),
                                           nrow(unique(status[status$Analyte == "pH", ])),
                                           nrow(unique(status[status$Analyte == "Temperature", ])),
                                           nrow(unique(status[status$Analyte == "Total Phosphorus", ])),
                                           nrow(unique(status[status$Analyte == "Total Suspended Solids", ]))
                                           ),
                                  trends=c(nrow(unique(trend[trend$Analyte == "E. Coli", ])),
                                           nrow(unique(trend[trend$Analyte == "Enterococcus", ])),
                                           nrow(unique(trend[trend$Analyte == "Dissolved Oxygen", ])),
                                           nrow(unique(trend[trend$Analyte == "pH",])),
                                           nrow(unique(trend[trend$Analyte == "Temperature", ])),
                                           nrow(unique(trend[trend$Analyte == "Total Phosphorus", ])),
                                           nrow(unique(trend[trend$Analyte == "Total Suspended Solids", ]))
                                           ))
colnames(station_summary_tbl) <- c("Analyte", "Number of stations w/ sufficent data for status analysis", "Number of stations w/ sufficent data for trend analysis")                                  

knitr::kable(station_summary_tbl, digits = 0, padding = 2, caption = tbls(name = "StnSumTable", caption = "Summary of stations with suffcient data for status or trend analysis"))                                 

```

`r length(unique(stn_to_use))` monitoring stations contained sufficient data to assess status and/or trends out of `r length(unique(df.all$Station_ID))` total monitoring stations within the `r agwqma` AgWQ Management Area 


```{r parm-summary-table}

knitr::kable(stns_param_summary_tbl, padding = 2, digits = 3, 
             caption = tbls(name = "parmSumTable", 
                            caption = "Summary of Monitoring Stations Status and Trend, where 'exceed' represents a single exceedance of the water quality standard within the last three years of available data. Note: DO = dissolved oxygen**"))

```


```{r DO-summary-map, eval = word_output, fig.cap=figs(name="DO_map", caption="Summary of stations that fit the criteria for status and trend analysis for dissolved oxygen. One or more exceedances within the last three years of available data defined whether a station was Meeting or Not Meeting. Trend was determined by significant trends associated with long-term datasets.**")}

knitr::include_graphics(paste0(project_dir,"/Figures/",station_summary_map_DO_file))

```

```{r Ecoli-summary-map, eval = word_output, fig.cap=figs(name="Ecoli_map", caption="Summary of stations that fit the criteria for status and trend analysis for E coli. One or more exceedances within the last three years of available data defined whether a station was Meeting or Not Meeting. Trend was determined by significant trends associated with long-term datasets. Clusters of stations (grey circles located on the western margin of the study area) had insufficient data to determine status and trends for E. coli.**")}

knitr::include_graphics(path = paste0(project_dir,"/Figures/",station_summary_map_ecoli_file))

```

```{r Entero-summary-map, eval = word_output, fig.cap=figs(name="Entero_map", caption="Summary of stations that fit the criteria for status and trend analysis for Enterococcus. One or more exceedances within the last three years of available data defined whether a station was Meeting or Not Meeting. Trend was determined by significant trends associated with long-term datasets.**")}

knitr::include_graphics(path = paste0(project_dir,"/Figures/",station_summary_map_entero_file))

```

```{r Temp-summary-map, eval = word_output, fig.cap=figs(name="Temperature_map", caption="Summary of stations that fit the criteria for status and trend analysis for temperature. One or more exceedances within the last three years of available data defined whether a station was Meeting or Not Meeting. Trend was determined by significant trends associated with long-term datasets.**")}

knitr::include_graphics(path = paste0(project_dir,"/Figures/",station_summary_map_temp_file))

```

```{r ph-summary-map, eval = word_output, fig.cap=figs(name="pH_map", caption="Summary of stations that fit the criteria for status and trend analysis for pH. One or more exceedances within the last three years of available data defined whether a station was Meeting or Not Meeting. Trend was determined by significant trends associated with long-term datasets.**")}

knitr::include_graphics(path = paste0(project_dir,"/Figures/",station_summary_map_pH_file))

```

```{r TP-summary-map, eval = word_output, fig.cap=figs(name="TP_map", caption="Summary of stations that fit the criteria for trend analysis for Total Phosphorus.  Trend was determined by significant trends associated with long-term datasets.**")}

knitr::include_graphics(path = paste0(project_dir,"/Figures/",station_summary_map_tp_file))

```

```{r TSS-summary-map, eval = word_output, fig.cap=figs(name="TSS_map", caption="Summary of stations that fit the criteria for status and trend analysis for Total Suspended Solids. Trend was determined by significant trends associated with long-term datasets.**")}

knitr::include_graphics(path = paste0(project_dir,"/Figures/",station_summary_map_tss_file))

```

# Conclusions

```{r conclusions-setup}

conclusions.DO <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "DO"), c("conclusion")]
conclusions.Ecoli <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "Ecoli"), c("conclusion")]
conclusions.Entero <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "Entero"), c("conclusion")]
conclusions.pH <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "pH"), c("conclusion")]
conclusions.Temp <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "Temp"), c("conclusion")]
conclusions.TP <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "TP"), c("conclusion")]
conclusions.TSS <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "TSS"), c("conclusion")]
conclusions.add <- Conc_LU[(Conc_LU$AgArea %in% agwqma & Conc_LU$topic == "Add_conc"), c("conclusion")]

```


**What are the overall status or trends?**

* *E. coli*: `r conclusions.Ecoli`
* *Enterococcus*: `r conclusions.Entero`
* *Dissolved Oxygen*: `r conclusions.DO`
* *pH*: `r conclusions.pH`
* *Temperature*: `r conclusions.Temp`
* *Total Phosphorus*: `r conclusions.TP`
* *Total Suspended Solids*: `r conclusions.TSS`


**Additional Conclusions:**

`r paste0("* ",conclusions.add,"\n", collapse="")`